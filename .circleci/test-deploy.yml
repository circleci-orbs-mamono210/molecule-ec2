---
version: 2.1
orbs:
  molecule-ec2: orbss/molecule-ec2@dev:<<pipeline.git.revision>>
  orb-tools: circleci/orb-tools@11.1
  aws-cli: circleci/aws-cli@3.1.3

filters: &filters
  tags:
    only: /.*/

jobs:
  ami-id-test:
    executor: molecule-ec2/default
    working_directory: ~/centos_update
    steps:
      - aws-cli/setup:
          profile-name: default
          role-arn: ${AWS_ROLE_ARN}
          role-session-name: circleci-orbs-molecule-ec2-playbook-test
          session-duration: '3600'
      - checkout
      - run:
          name: Prepare test resources
          command: |
            mv test_resources/roles/centos_update/defaults .
            mv test_resources/roles/centos_update/handlers .
            mv test_resources/roles/centos_update/molecule .
            mv test_resources/roles/centos_update/tasks .
      - molecule-ec2/execute:
          ansible-user: "ec2-user"
          aws-ami-id: "ami-01476cac56c95883c" # CentOS Stream 9 aarch64 ap-northeast-1
          aws-instance-type: "t4g.medium"
          aws-resource-name: "circleci-orbs-molecule-ec2-ami-id-test"
          aws-vpc-subnet-id: "subnet-022a704b3061b8b39" # 環境変数やcontextでは値を渡せない
          circleci-timeout: "15m"
  playbook-test:
    executor: molecule-ec2/default
    steps:
      - aws-cli/setup:
          profile-name: default
          role-arn: ${AWS_ROLE_ARN}
          role-session-name: circleci-orbs-molecule-ec2-playbook-test
          session-duration: '3600'
      - checkout
      - run:
          name: Prepare test resources
          command: |
            mv test_resources/playbooks/wordpress_install/group_vars .
            mv test_resources/playbooks/wordpress_install/molecule .
            mv test_resources/playbooks/wordpress_install/roles .
            mv test_resources/playbooks/wordpress_install/install.yml .
      - molecule-ec2/execute:
          ansible-user: "centos"
          aws-ami-name: "centos-stream8-1*"
          aws-ami-owner-id: "808683561341" # 環境変数やcontextでは値を渡せない
          aws-resource-name: "circleci-orbs-molecule-ec2-playbook-test"
          aws-vpc-subnet-id: "subnet-022a704b3061b8b39" # 環境変数やcontextでは値を渡せない
          circleci-timeout: "15m"
  resource-class-test:
    executor:
      name: molecule-ec2/default
      resource_class: medium+
    steps:
      - aws-cli/setup:
          profile-name: default
          role-arn: ${AWS_ROLE_ARN}
          role-session-name: circleci-orbs-molecule-ec2-resource-class-test
          session-duration: '3600'
      - checkout
      - run:
          name: Prepare test resources
          command: |
            mv test_resources/playbooks/wordpress_install/group_vars .
            mv test_resources/playbooks/wordpress_install/molecule .
            mv test_resources/playbooks/wordpress_install/roles .
            mv test_resources/playbooks/wordpress_install/install.yml .
      - molecule-ec2/execute:
          ansible-user: "centos"
          aws-ami-name: "centos-stream8-1*"
          aws-ami-owner-id: "808683561341" # 環境変数やcontextでは値を渡せない
          aws-resource-name: "circleci-orbs-molecule-ec2-resouce-class-test"
          aws-vpc-subnet-id: "subnet-022a704b3061b8b39" # 環境変数やcontextでは値を渡せない
          circleci-timeout: "15m"

workflows:
  test-deploy:
    jobs:
      - ami-id-test:
          context:
            - AWS_OPENID_CONNECT_TOKENS
          filters: *filters
      - playbook-test:
          context:
            - AWS_OPENID_CONNECT_TOKENS
          filters: *filters
      - resource-class-test:
          context:
            - AWS_OPENID_CONNECT_TOKENS
          filters: *filters
      - orb-tools/pack:
          filters: *filters
      - orb-tools/publish:
          orb-name: orbss/molecule-ec2
          vcs-type: << pipeline.project.type >>
          pub-type: production
          requires:
            - orb-tools/pack
            - playbook-test
            - resource-class-test
          context: <publishing-context>
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
